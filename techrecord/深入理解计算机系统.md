## 笔记回顾
 
 
 # 第5章——优化程序性能

* 20190329

### 时钟周期
时钟周期是计算机中最基本的、最小的时间单位，cpu晶体晶振一次（即在逻辑0和逻辑1切换一次）需要的时间。cpu的主频指在1秒内cpu运行的时钟周期数，比如1Ghz，指CPU在1秒内可以运行10亿个时钟周期；

通过时钟周期可以判断程序的运行效率，比如在排序中，平均每个数排序所用的时钟周期越短，则排序效率越高；

### 编译器优化
编译器在在将源代码编译为汇编代码的过程中，会对源代码进行一些优化，但这些优化是有局限性的，优化时必须保证安全性，即保证编译后的运行结果在任何情况下都和源代码直接编译后的运行结果一致；比如编译器不能简单的把异名指针当成不同的指针，因为它们可能指向同一内存区；

* 20190401

### 理解现代处理器

现代处理器实现了指令级并行运算，多条指令可以同时处理，处理器在执行指令时，会先把指令译码成各种操作，然后发送给各个功能单元进行运算；

在机器级上限制代码运行下限的有两个指标：
1. 操作延迟：即一个操作所需花费的时钟周期；
2. 吞吐量：两个操作之间的时间间隔的倒数k，当有m个功能单元可以执行此操作时，吞吐量为mk；
最优的代码运行速度会达到处理器吞吐量的下限；

### 运行效率分析举例：
假设加法操作的延迟为3，乘法为5；

例1：
```
a=b+c*d
```
由于加法和乘法可以并行运算，上面操作的总的运行时间为5；

例2
```
a=b+c;
a=a*b;
```
由于第二条指令要用到第一条的结果，上面操作的总的运行时间为8；

* 20190402

### 循环展开
循环展开对程序的优化体现在两个方面：
1. 减少循环指令开支，比如条件判断，累加操作；
2. 循环体内的多个数值可以运用处理器指令级并行能力进行同时操作；

运用指令级并行能力，达到吞吐量的下限，有两种方法：
1. 增加寄存器
比如多个数乘法运算，可以分解为奇数项和偶数项分别相乘，存在不同的寄存器中，最后再合并；
2. 运算顺序重新结合
借助乘法和加法的交换律，先运算与寄存器无关的项；

### 一些限制因素
1. 寄存器溢出，当循环展开过大，使循环体内的寄存器数量大于处理器中寄存器数量时，数据会存储在内存栈中，这样反而会增加访问开销；
2. 条件判断错误，由于处理器按流水线执行指令，当发现条件判断错误时，前面的计算会丢弃，浪费性能；解决办法：把条件判断改为条件数据；
